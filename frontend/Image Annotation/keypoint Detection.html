<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Image Segmentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .brush-slider { 
      -webkit-appearance: none; 
      appearance: none; 
      height: 6px; 
      border-radius: 3px; 
      background: #e5e7eb; 
      outline: none; 
      width: 100%; 
    }

    .brush-slider::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      appearance: none; 
      width: 20px; 
      height: 20px; 
      border-radius: 50%; 
      background: #2563eb; 
      cursor: pointer; 
      border: 2px solid white; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    }
    .brush-track { 
      background: linear-gradient(to right, #2563eb 0%, #2563eb var(--progress), #e5e7eb var(--progress), #e5e7eb 100%); 
    }
    .drawing-canvas { 
      cursor: crosshair; 
      z-index: 10; }
  </style>
</head>
<body class="bg-slate-50 font-sans text-gray-900 overflow-hidden">
  
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5" viewBox="0 0 24 24">
        <path fill="#2563eb" d="M4 3h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>
        <circle cx="8" cy="8" r="2.25" fill="#fff"/>
        <path fill="#93c5fd" d="M3 18l6-6 3 3 3-4 6 7v1H3z"/>
      </svg>
      <div>
        <h1 id="fileName" class="text-sm font-bold">Image.png</h1>
        <div class="text-xs text-gray-500">Image Segmentation</div>
      </div>
    </div>
    <div class="flex gap-2">
      <button class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-md bg-white text-gray-700 text-sm font-medium hover:bg-gray-50">
        <a href="/frontend/Datasets.html">‚Üê Back to project</a>
      </button>
      <button id="saveBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-md text-sm font-medium hover:bg-gray-800">üîíSave</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="grid grid-cols-1 xl:grid-cols-4 gap-4 p-4 h-screen">
    
    <!-- Left Section -->
    <section class="xl:col-span-3 bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center">
      
      <!-- Upload Area -->
      <div id="card" class="border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 w-full max-w-4xl h-80 md:h-96 lg:h-[460px] flex items-center justify-center cursor-pointer transition-all duration-200 hover:border-blue-600 hover:bg-blue-50">
        <div id="stack" class="flex flex-col gap-3 items-center w-full h-full">
          <div id="hint" class="text-gray-500 text-center p-5 text-base font-medium">Click to select, or drop an image</div>
        </div>
        <input id="file" type="file" accept="image/*" class="absolute w-px h-px opacity-0 pointer-events-none" />
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-3 justify-center mt-4">
        <button id="drawBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">‚úèÔ∏è Draw</button>
        <button id="clearBtn" class="bg-red-50 text-red-800 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition-colors">üóëÔ∏è Clear</button>
        <button id="undoBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled>‚Ü∂ Undo</button>
      </div>

      <!-- URL Input -->
      <div class="flex gap-2 justify-center mt-3">
        <input id="urlInput" class="flex-1 max-w-md px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste image URL" />
        <button id="addUrl" class="px-4 py-2 border border-blue-600 text-blue-600 bg-blue-50 rounded-lg font-bold hover:bg-blue-100 transition-colors">Add</button>
      </div>

      <div id="fileInfo" class="mt-2 text-center text-gray-500 text-sm">No image selected</div>
    </section>

    <!-- Right Sidebar -->
    <aside class="bg-white border border-gray-200 rounded-xl p-4 overflow-y-auto">
      
      <!-- Segmentation Classes -->
      <div class="mb-4">
        <h3 class="text-lg font-bold mb-3">Segmentation classes</h3>
        <div class="space-y-2">
          <div class="flex items-center justify-between border border-gray-200 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition-shadow">
            <span class="font-bold text-base text-red-500">Background</span>
            <button class="border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold" data-class="Background">Select</button>
          </div>
          <div class="flex items-center justify-between border border-gray-200 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition-shadow">
            <span class="font-bold text-base text-blue-600">Foreground</span>
            <button class="border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold" data-class="Foreground">Select</button>
          </div>
          <div class="flex items-center justify-between border border-gray-200 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition-shadow">
            <span class="font-bold text-base text-green-600">Sky</span>
            <button class="border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold" data-class="Sky">Select</button>
          </div>
          <div class="flex items-center justify-between border border-gray-200 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition-shadow">
            <span class="font-bold text-base text-amber-500">Ground</span>
            <button class="border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold" data-class="Ground">Select</button>
          </div>
          <div class="flex items-center justify-between border border-gray-200 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition-shadow">
            <span class="font-bold text-base text-violet-600">Vegetation</span>
            <button class="border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold" data-class="Vegetation">Select</button>
          </div>
        </div>
      </div>

      <!-- Brush Settings -->
      <div class="mb-4">
        <h3 class="text-lg font-bold mb-3">Brush Settings</h3>
        <div class="mb-2">
          <span class="text-sm font-medium text-gray-700">Brush Size: <span id="brushSizeValue">38</span>%</span>
        </div>
        <input type="range" id="brushSizeSlider" min="1" max="100" value="38" class="brush-slider brush-track w-full" style="--progress: 38%">
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>1%</span>
          <span>100%</span>
        </div>
      </div>

      <!-- Paint Controls -->
      <div class="space-y-2">
        <button id="startPaintingBtn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition-colors">Start Painting</button>
        <button id="eraseModeBtn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition-colors">Erase Mode</button>
        <button id="paintModeBtn" class="w-full bg-gray-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-800 transition-colors">Paint Mode</button>
      </div>
    </aside>
  </main>

<script>
  // State
  let activeImage = null, drawMode = false, paintingActive = false, eraseMode = false, isPainting = false;
  let brushSize = 38, currentClass = 'Background';
  let ctx = null, currentCanvas = null, history = [], currentStroke = [];

  // Class colors
  const classColors = { 'Background': '#ef4444', 'Foreground': '#3b82f6', 'Sky': '#10b981', 'Ground': '#f59e0b', 'Vegetation': '#8b5cf6' };

  // Elements
  const elements = {
    card: document.getElementById('card'),
    stack: document.getElementById('stack'),
    fileInput: document.getElementById('file'),
    hint: document.getElementById('hint'),
    fileInfo: document.getElementById('fileInfo'),
    urlInput: document.getElementById('urlInput'),
    fileName: document.getElementById('fileName')
  };

  // Create drawing canvas
  function createCanvas(container) {
    const existing = container.querySelector('canvas');
    if (existing) existing.remove();
    
    const canvas = document.createElement('canvas');
    canvas.className = 'drawing-canvas';
    canvas.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:auto;cursor:crosshair;z-index:10;';
    
    const img = container.querySelector('img');
    if (img) {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      canvas.style.width = img.offsetWidth + 'px';
      canvas.style.height = img.offsetHeight + 'px';
    }
    
    container.appendChild(canvas);
    return canvas;
  }

  // Get drawing position
  function getPos(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return [(clientX - rect.left) * scaleX, (clientY - rect.top) * scaleY];
  }

  // Start drawing
  function startDraw(e) {
    if (!drawMode || !paintingActive) return;
    isPainting = true;
    currentStroke = [];
    
    const [x, y] = getPos(e, currentCanvas);
    
    // Set drawing properties
    ctx.globalCompositeOperation = eraseMode ? 'destination-out' : 'source-over';
    ctx.strokeStyle = eraseMode ? 'rgba(0,0,0,1)' : classColors[currentClass];
    ctx.lineWidth = brushSize / 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.globalAlpha = eraseMode ? 1 : 0.7;
    
    // Start path
    ctx.beginPath();
    ctx.moveTo(x, y);
    currentStroke.push({ x, y, class: currentClass, erase: eraseMode, isStart: true });
    e.preventDefault();
  }

  // Continue drawing
  function draw(e) {
    if (!isPainting || !drawMode || !paintingActive) return;
    
    const [x, y] = getPos(e, currentCanvas);
    ctx.lineTo(x, y);
    ctx.stroke();
    currentStroke.push({ x, y, class: currentClass, erase: eraseMode });
    e.preventDefault();
  }

  // Stop drawing
  function stopDraw(e) {
    if (!isPainting) return;
    isPainting = false;
    ctx.closePath();
    
    if (currentStroke.length > 0) {
      history.push([...currentStroke]);
      if (history.length > 50) history.shift();
      updateUndoBtn();
    }
    e.preventDefault();
  }

  // Clear canvas
  function clearCanvas() {
    if (!currentCanvas || !confirm('Clear all painting?')) return;
    ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
    history = [];
    updateUndoBtn();
  }

  // Undo last stroke
  function undo() {
    if (!currentCanvas || !history.length) return;
    history.pop();
    redrawCanvas();
    updateUndoBtn();
  }

  // Redraw entire canvas
  function redrawCanvas() {
    ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
    
    history.forEach(stroke => {
      if (stroke.length === 0) return;
      
      const firstPoint = stroke[0];
      ctx.globalCompositeOperation = firstPoint.erase ? 'destination-out' : 'source-over';
      ctx.strokeStyle = firstPoint.erase ? 'rgba(0,0,0,1)' : classColors[firstPoint.class];
      ctx.lineWidth = brushSize / 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.globalAlpha = firstPoint.erase ? 1 : 0.7;
      
      ctx.beginPath();
      ctx.moveTo(firstPoint.x, firstPoint.y);
      
      stroke.slice(1).forEach(point => ctx.lineTo(point.x, point.y));
      ctx.stroke();
    });
  }

  // Update undo button state
  function updateUndoBtn() {
    const btn = document.getElementById('undoBtn');
    btn.disabled = !history.length;
    btn.classList.toggle('opacity-50', !history.length);
    btn.classList.toggle('cursor-not-allowed', !history.length);
  }

  // Initialize drawing
  function initDrawing(container) {
    currentCanvas = createCanvas(container);
    ctx = currentCanvas.getContext('2d');
    
    // Add all event listeners
    ['mousedown', 'touchstart'].forEach(e => currentCanvas.addEventListener(e, startDraw));
    ['mousemove', 'touchmove'].forEach(e => currentCanvas.addEventListener(e, draw));
    ['mouseup', 'mouseleave', 'touchend'].forEach(e => currentCanvas.addEventListener(e, stopDraw));
    
    history = [];
    updateUndoBtn();
  }

  // Remove drawing
  function removeDrawing() {
    if (!currentCanvas) return;
    currentCanvas.remove();
    currentCanvas = ctx = null;
    history = [];
    updateUndoBtn();
  }

  // Event Listeners
  document.getElementById('brushSizeSlider').oninput = (e) => {
    brushSize = +e.target.value;
    document.getElementById('brushSizeValue').textContent = brushSize;
    e.target.style.setProperty('--progress', `${brushSize}%`);
  };

  document.querySelectorAll('[data-class]').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('[data-class]').forEach(b => 
        b.className = 'border border-gray-300 rounded-md px-3 py-2 bg-white text-xs font-semibold'
      );
      btn.className = 'border border-blue-500 rounded-md px-3 py-2 bg-blue-50 text-xs font-semibold';
      currentClass = btn.dataset.class;
    };
  });

  elements.card.onclick = (e) => {
    if (e.target === currentCanvas || currentCanvas?.contains(e.target)) return;
    elements.fileInput.click();
  };

  elements.fileInput.onchange = (e) => e.target.files?.[0] && loadFile(e.target.files[0]);

  // Drag & Drop
  ['dragenter', 'dragover'].forEach(e => elements.card.addEventListener(e, (ev) => {
    ev.preventDefault();
    elements.card.className = 'border-2 border-dashed border-blue-600 rounded-xl bg-blue-50 w-full max-w-4xl h-80 md:h-96 lg:h-[460px] flex items-center justify-center cursor-pointer transition-all duration-200';
    elements.hint.textContent = 'Drop your image here';
  }));

  elements.card.addEventListener('dragleave', (e) => {
    e.preventDefault();
    elements.card.className = 'border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 w-full max-w-4xl h-80 md:h-96 lg:h-[460px] flex items-center justify-center cursor-pointer transition-all duration-200 hover:border-blue-600 hover:bg-blue-50';
    elements.hint.textContent = 'Click to select, or drop an image';
  });

  elements.card.addEventListener('drop', (e) => {
    e.preventDefault();
    elements.card.dispatchEvent(new Event('dragleave'));
    if (e.dataTransfer.files?.[0]) loadFile(e.dataTransfer.files[0]);
  });

  document.getElementById('addUrl').onclick = () => {
    const url = elements.urlInput.value.trim();
    if (!url) return;
    elements.hint.textContent = 'Loading from URL...';
    elements.hint.className = 'text-blue-600 text-center p-5 text-base font-semibold';
    createImage(url, 'Image from URL');
    elements.urlInput.value = '';
  };

  // Main control buttons
  document.getElementById('drawBtn').onclick = () => {
    if (!activeImage) return alert('Please upload an image first!');
    
    drawMode = !drawMode;
    const btn = document.getElementById('drawBtn');
    
    if (drawMode) {
      btn.textContent = '‚è∏Ô∏è Stop';
      btn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition-colors';
      initDrawing(activeImage.container);
    } else {
      btn.textContent = '‚úèÔ∏è Draw';
      btn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors';
      removeDrawing();
      paintingActive = false;
      const startBtn = document.getElementById('startPaintingBtn');
      startBtn.textContent = 'Start Painting';
      startBtn.className = 'w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition-colors';
    }
  };

  document.getElementById('startPaintingBtn').onclick = () => {
    if (!currentCanvas) return alert('Please enable draw mode first!');
    
    paintingActive = !paintingActive;
    const btn = document.getElementById('startPaintingBtn');
    btn.textContent = paintingActive ? 'Stop Painting' : 'Start Painting';
    btn.className = paintingActive ? 
      'w-full bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition-colors' :
      'w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition-colors';
  };

  document.getElementById('eraseModeBtn').onclick = () => {
    eraseMode = true;
    document.getElementById('eraseModeBtn').className = 'w-full bg-red-100 text-red-800 px-4 py-2 rounded-lg font-bold hover:bg-red-200 transition-colors';
    document.getElementById('paintModeBtn').className = 'w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition-colors';
  };

  document.getElementById('paintModeBtn').onclick = () => {
    eraseMode = false;
    document.getElementById('paintModeBtn').className = 'w-full bg-gray-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-800 transition-colors';
    document.getElementById('eraseModeBtn').className = 'w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition-colors';
  };

  document.getElementById('clearBtn').onclick = () => currentCanvas ? clearCanvas() : alert('Please enable draw mode first!');
  document.getElementById('undoBtn').onclick = () => currentCanvas ? undo() : alert('Please enable draw mode first!');

  document.getElementById('saveBtn').onclick = () => {
    if (!activeImage) return alert('No image to save!');
    
    const data = {
      timestamp: new Date().toISOString(),
      brushSize, currentClass, eraseMode,
      segmentationData: currentCanvas?.toDataURL('image/png'),
      imageName: activeImage.name,
      imageData: activeImage.src,
      strokeHistory: history.length
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `segmentation_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('Segmentation saved successfully!');
  };

  // Helper Functions
  function loadFile(file) {
    if (!file.type.startsWith('image/')) return alert('Please select an image file');
    
    elements.hint.textContent = 'Loading...';
    elements.hint.className = 'text-blue-600 text-center p-5 text-base font-semibold';

    const reader = new FileReader();
    reader.onload = (e) => createImage(e.target.result, file.name);
    reader.onerror = () => {
      elements.hint.textContent = 'Failed to load image';
      elements.hint.className = 'text-red-600 text-center p-5 text-base font-semibold';
    };
    reader.readAsDataURL(file);
  }

  function createImage(src, name) {
    // Reset all modes when new image loads
    if (drawMode) {
      drawMode = paintingActive = false;
      const drawBtn = document.getElementById('drawBtn');
      const startBtn = document.getElementById('startPaintingBtn');
      drawBtn.textContent = '‚úèÔ∏è Draw';
      drawBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors';
      startBtn.textContent = 'Start Painting';
      startBtn.className = 'w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition-colors';
      removeDrawing();
    }

    elements.hint.remove();
    const container = document.createElement('div');
    container.className = 'relative flex items-center justify-center w-full h-full rounded-lg overflow-hidden';

    const img = new Image();
    img.onload = () => {
      img.className = 'max-w-full max-h-full w-auto h-auto rounded-lg shadow-lg';
      container.appendChild(img);
      elements.stack.appendChild(container);
      activeImage = { container, img, name, src };
      elements.fileName.textContent = name;
      elements.fileInfo.innerHTML = `Loaded: <b>${name}</b>`;
    };
    img.onerror = () => {
      elements.stack.innerHTML = '<div class="text-red-600 text-center p-5 text-base font-semibold">Failed to load image</div>';
    };
    img.src = src;
  }

  // Initialize first class selection
  document.querySelector('[data-class="Background"]').click();
</script>
</body>
</html>
