<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Image Classification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom slider styles */
    .confidence-slider {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
      width: 100%;
    }

    .confidence-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .confidence-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .confidence-track {
      background: linear-gradient(to right, #2563eb 0%, #2563eb var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
    }

    .drawing-canvas {
      cursor: crosshair !important;
    }
  </style>
</head>
<body class="bg-slate-50 font-sans text-gray-900 overflow-hidden">
  
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path fill="#2563eb" d="M4 3h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>
        <circle cx="8" cy="8" r="2.25" fill="#fff"/>
        <path fill="#93c5fd" d="M3 18l6-6 3 3 3-4 6 7v1H3z"/>
      </svg>
      <div>
        <h1 id="fileName" class="text-sm font-bold">Image.png</h1>
        <div class="text-xs text-gray-500">Image Classification</div>
      </div>
    </div>
    <div class="flex gap-2">
            <button class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-md bg-white text-gray-700 text-sm font-medium hover:bg-gray-50">
                <i class="bi bi-arrow-left"></i>
               <a href="/frontend/Datasets.html">‚Üê Back to project</a>
            </button>
            <button id="saveBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-md text-sm font-medium hover:bg-gray-800">
                <i class="bi bi-save"></i>
                üîíSave 
            </button>
        </div>
  </header>

  <!-- Main Content -->
  <main class="grid grid-cols-1 xl:grid-cols-4 gap-4 p-4 h-screen">
    
    <!-- Left Section - Upload Area -->
    <section class="xl:col-span-3 bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center">
      
      <!-- Upload Card -->
      <div id="card" class="border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 w-full max-w-4xl h-80 md:h-96 lg:h-[460px] flex items-center justify-center cursor-pointer transition-all duration-200 hover:border-blue-600 hover:bg-blue-50 mx-auto">
        <div id="stack" class="flex flex-col gap-3 items-center w-full h-full">
          <div id="hint" class="text-gray-500 text-center p-5 text-base font-medium">
            Click to select, or drop an image
          </div>
        </div>
        <input id="file" type="file" accept="image/*" class="absolute w-px h-px opacity-0 pointer-events-none" />
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-3 justify-center mt-4">
        <button id="drawBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">
          ‚úèÔ∏è Draw
        </button>
        <button id="clearBtn" class="bg-red-50 text-red-800 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition-colors">
          üóëÔ∏è Clear all
        </button>
        <button id="undoBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled>
          ‚Ü∂ Undo
        </button>
      </div>

      <!-- URL Input -->
      <div class="flex gap-2 justify-center mt-3">
        <input id="urlInput" class="flex-1 max-w-md px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
               placeholder="Paste image URL" />
        <button id="addUrl" class="px-4 py-2 border border-blue-600 text-blue-600 bg-blue-50 rounded-lg font-bold hover:bg-blue-100 transition-colors">
          Add
        </button>
      </div>

      <!-- File Info -->
      <div id="fileInfo" class="mt-2 text-center text-gray-500 text-sm">
        No image selected
      </div>
    </section>

    <!-- Right Sidebar -->
    <aside class="bg-white border border-gray-200 rounded-xl p-4 overflow-y-auto">
      
      <!-- Detection Categories -->
      <div class="mb-5">
        <h3 class="text-lg font-bold mb-3">Detection Categories</h3>
        <div class="space-y-2">
          <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
            <input type="checkbox" id="nature" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">Nature</span>
          </label>
          <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
            <input type="checkbox" id="urban" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">Urban</span>
          </label>
          <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
            <input type="checkbox" id="peoples" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">Peoples</span>
          </label>
          <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
            <input type="checkbox" id="animals" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">Animals</span>
          </label>
          <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
            <input type="checkbox" id="vehicles" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">Vehicles</span>
          </label>
        </div>
      </div>

      <!-- Confidence Level -->
      <div class="mb-5">
        <h3 class="text-lg font-bold mb-3">Confidence Level</h3>
        <div class="px-2">
          <div class="mb-3">
            <span class="text-sm font-medium text-gray-700">Confidence level: <span id="confidenceValue">50</span>%</span>
          </div>
          <div class="relative">
            <input 
              type="range" 
              id="confidenceSlider" 
              min="0" 
              max="100" 
              value="50" 
              class="confidence-slider confidence-track w-full"
              style="--progress: 50%"
            >
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>0%</span>
              <span>100%</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

<script>
  // ---------- State ----------
  let activeImage = null;
  let confidenceLevel = 50;
  let selectedCategories = [];
  let drawMode = false;
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  let ctx = null;
  let drawHistory = [];
  let drawHistoryIndex = -1;
  let currentCanvas = null;

  // ---------- Elements ----------
  const card = document.getElementById('card');
  const stack = document.getElementById('stack');
  const fileInput = document.getElementById('file');
  const hint = document.getElementById('hint');
  const fileInfo = document.getElementById('fileInfo');
  const urlInput = document.getElementById('urlInput');
  const saveBtn = document.getElementById('saveBtn');
  const fileName = document.getElementById('fileName');
  const confidenceSlider = document.getElementById('confidenceSlider');
  const confidenceValue = document.getElementById('confidenceValue');
  const drawBtn = document.getElementById('drawBtn');
  const clearBtn = document.getElementById('clearBtn');
  const undoBtn = document.getElementById('undoBtn');

  // ---------- Drawing Functions ----------
  function createDrawingCanvas(container) {
    // Remove existing canvas if any
    const existingCanvas = container.querySelector('canvas');
    if (existingCanvas) {
      existingCanvas.remove();
    }
    
    const canvas = document.createElement('canvas');
    canvas.style.position = 'absolute';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    canvas.style.pointerEvents = 'auto';
    canvas.className = 'drawing-canvas';
    
    // Set canvas size to match container
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    container.style.position = 'relative';
    container.appendChild(canvas);
    
    return canvas;
  }

  function getPointerPos(e, canvas) {
    let clientX, clientY;
    if (e.touches && e.touches.length > 0) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const rect = canvas.getBoundingClientRect();
    return [clientX - rect.left, clientY - rect.top];
  }

  function startDraw(e) {
    if (!drawMode) return;
    isDrawing = true;
    [lastX, lastY] = getPointerPos(e, currentCanvas);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    e.preventDefault();
  }

  function draw(e) {
    if (!isDrawing || !drawMode) return;
    const [x, y] = getPointerPos(e, currentCanvas);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
    e.preventDefault();
  }

  function stopDraw(e) {
    if (!isDrawing) return;
    ctx.closePath();
    isDrawing = false;
    saveDrawState();
    e.preventDefault();
  }

  function saveDrawState() {
    if (!currentCanvas) return;
    // Remove future history if we're not at the end
    if (drawHistoryIndex < drawHistory.length - 1) {
      drawHistory = drawHistory.slice(0, drawHistoryIndex + 1);
    }
    drawHistory.push(currentCanvas.toDataURL());
    drawHistoryIndex++;
    updateUndoBtnState();
  }

  function undoDraw() {
    if (drawHistoryIndex <= 0) return;
    drawHistoryIndex--;
    if (drawHistoryIndex >= 0) {
      restoreDrawState(drawHistory[drawHistoryIndex]);
    } else {
      ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
    }
    updateUndoBtnState();
  }

  function restoreDrawState(dataUrl) {
    if (!currentCanvas || !dataUrl) return;
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
      ctx.drawImage(img, 0, 0);
    };
    img.src = dataUrl;
  }

  function clearDraw() {
    if (!currentCanvas) return;
    ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
    drawHistory = [''];
    drawHistoryIndex = 0;
    updateUndoBtnState();
  }

  function updateUndoBtnState() {
    if (drawHistoryIndex > 0) {
      undoBtn.disabled = false;
      undoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      undoBtn.disabled = true;
      undoBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }

  function initDrawing(container) {
    currentCanvas = createDrawingCanvas(container);
    ctx = currentCanvas.getContext('2d');
    ctx.strokeStyle = '#2563eb';
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.lineWidth = 3;

    // Mouse events
    currentCanvas.addEventListener('mousedown', startDraw);
    currentCanvas.addEventListener('mousemove', draw);
    currentCanvas.addEventListener('mouseup', stopDraw);
    currentCanvas.addEventListener('mouseleave', stopDraw);

    // Touch events
    currentCanvas.addEventListener('touchstart', startDraw);
    currentCanvas.addEventListener('touchmove', draw);
    currentCanvas.addEventListener('touchend', stopDraw);
    
    // Initialize history with empty canvas
    drawHistory = [''];
    drawHistoryIndex = 0;
    updateUndoBtnState();
  }

  function removeDrawing() {
    if (!currentCanvas) return;
    
    // Remove event listeners
    currentCanvas.removeEventListener('mousedown', startDraw);
    currentCanvas.removeEventListener('mousemove', draw);
    currentCanvas.removeEventListener('mouseup', stopDraw);
    currentCanvas.removeEventListener('mouseleave', stopDraw);
    currentCanvas.removeEventListener('touchstart', startDraw);
    currentCanvas.removeEventListener('touchmove', draw);
    currentCanvas.removeEventListener('touchend', stopDraw);

    currentCanvas.remove();
    currentCanvas = null;
    ctx = null;
    drawHistory = [];
    drawHistoryIndex = -1;
    updateUndoBtnState();
  }

  // ---------- Event Listeners ----------

  // Confidence Level Logic
  confidenceSlider.addEventListener('input', (e) => {
    confidenceLevel = parseInt(e.target.value);
    confidenceValue.textContent = confidenceLevel;
    
    // Update slider track color
    const progress = (confidenceLevel / 100) * 100;
    e.target.style.setProperty('--progress', `${progress}%`);
  });

  // Category Selection Logic
  const categoryCheckboxes = ['nature', 'urban', 'peoples', 'animals', 'vehicles'];
  
  categoryCheckboxes.forEach(id => {
    const checkbox = document.getElementById(id);
    checkbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        selectedCategories.push(id);
      } else {
        selectedCategories = selectedCategories.filter(cat => cat !== id);
      }
      console.log('Selected categories:', selectedCategories);
    });
  });

  // Upload Logic
  card.addEventListener('click', (e) => {
    if (e.target === currentCanvas) return; // Don't trigger file input when clicking on canvas
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    if (!e.target.files || !e.target.files.length) return;
    const file = e.target.files[0];
    loadImageFile(file);
  });

  // Drag & Drop
  card.addEventListener('dragenter', (e) => {
    e.preventDefault();
    card.classList.remove('border-gray-300', 'bg-gray-50');
    card.classList.add('border-blue-600', 'bg-blue-50');
    hint.textContent = 'Drop your image here';
  });

  card.addEventListener('dragover', (e) => {
    e.preventDefault();
  });

  card.addEventListener('dragleave', (e) => {
    e.preventDefault();
    card.classList.remove('border-blue-600', 'bg-blue-50');
    card.classList.add('border-gray-300', 'bg-gray-50');
    hint.textContent = 'Click to select, or drop an image';
  });

  card.addEventListener('drop', (e) => {
    e.preventDefault();
    card.classList.remove('border-blue-600', 'bg-blue-50');
    card.classList.add('border-gray-300', 'bg-gray-50');
    const file = e.dataTransfer.files?.[0];
    if (file) {
      loadImageFile(file);
    }
  });

  // URL Loading
  document.getElementById('addUrl').addEventListener('click', () => {
    const url = urlInput.value.trim();
    if (!url) return;
    
    hint.textContent = 'Loading from URL...';
    hint.className = 'text-blue-600 text-center p-5 text-base font-semibold';
    
    appendImage(url, 'Image from URL');
    urlInput.value = '';
  });

  // Drawing Controls
  drawBtn.addEventListener('click', () => {
    if (!activeImage || !activeImage.container) {
      alert('Please upload an image first');
      return;
    }
    
    drawMode = !drawMode;
    if (drawMode) {
      drawBtn.textContent = '‚è∏Ô∏è Stop';
      drawBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
      drawBtn.classList.add('bg-red-600', 'hover:bg-red-700');
      initDrawing(activeImage.container);
    } else {
      drawBtn.textContent = '‚úèÔ∏è Draw';
      drawBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
      drawBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      removeDrawing();
    }
  });

  clearBtn.addEventListener('click', () => {
    if (!drawMode || !currentCanvas) {
      alert('Please enable drawing mode first');
      return;
    }
    if (confirm('Clear all annotations?')) {
      clearDraw();
    }
  });

  undoBtn.addEventListener('click', () => {
    if (!drawMode || !currentCanvas) {
      alert('Please enable drawing mode first');
      return;
    }
    undoDraw();
  });

  // Save Function
  saveBtn.addEventListener('click', () => {
    if (!activeImage) {
      alert('No image to save!');
      return;
    }

    const payload = {
      timestamp: new Date().toISOString(),
      confidenceLevel: confidenceLevel,
      selectedCategories: selectedCategories,
      imageName: activeImage.name,
      imageData: activeImage.src,
      annotations: currentCanvas ? currentCanvas.toDataURL() : null
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `classification_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Classification saved successfully!');
  });

  // ---------- Helper Functions ----------
  function loadImageFile(file) {
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }

    hint.textContent = 'Loading...';
    hint.className = 'text-blue-600 text-center p-5 text-base font-semibold';

    const reader = new FileReader();
    reader.onload = (e) => {
      appendImage(e.target.result, file.name);
    };
    reader.onerror = () => {
      hint.textContent = 'Failed to load image';
      hint.className = 'text-red-600 text-center p-5 text-base font-semibold';
    };
    reader.readAsDataURL(file);
  }

  function appendImage(src, name) {
    // Remove drawing mode if active
    if (drawMode) {
      drawMode = false;
      drawBtn.textContent = '‚úèÔ∏è Draw';
      drawBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
      drawBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      removeDrawing();
    }

    hint.remove();
    
    const container = document.createElement('div');
    container.className = 'relative flex items-center justify-center w-full h-full rounded-lg overflow-hidden';

    const img = new Image();
    img.onload = () => {
      img.className = 'max-w-full max-h-full w-auto h-auto rounded-lg shadow-lg';
      container.appendChild(img);
      stack.appendChild(container);

      activeImage = { container, img, name, src };
      updateFilename(name);
    };

    img.onerror = () => {
      stack.innerHTML = '<div class="text-red-600 text-center p-5 text-base font-semibold">Failed to load image</div>';
    };

    img.src = src;
  }

  function updateFilename(name) {
    fileName.textContent = name;
    fileInfo.innerHTML = `Loaded: <b>${name}</b>`;
  }

</script>
</body>
</html>
